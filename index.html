<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§è€ƒå ´ç®¡ç†çœ‹æ¿ - By é˜¿å‰›è€å¸«</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        hand: ['"Zen Maru Gothic"', 'sans-serif'],
                        tech: ['"Orbitron"', 'sans-serif'],
                    },
                    colors: {
                        paper: 'var(--bg-paper)',
                        ink: 'var(--text-ink)',
                        pencil: 'var(--border-pencil)',
                        highlight: 'var(--color-highlight)',
                        danger: 'var(--color-danger)',
                        success: 'var(--color-success)',
                        card: 'var(--bg-card)',
                        modal: 'var(--bg-modal)',
                    },
                    animation: {
                        'marquee': 'marquee 25s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(100vw)' },
                            '100%': { transform: 'translateX(-100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* æ³¨éŸ³å­—é«”å®šç¾© */
        @font-face {
            font-family: 'ã„…æ³¨éŸ³èŠ«è½ Regular';
            src: url('https://kentxchang-goedutw.github.io/web/BpmfIansui-Regular_0.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* æ³¨éŸ³æ¨¡å¼å¼·åˆ¶å¥—ç”¨ */
        .font-zhuyin, .font-zhuyin * {
            font-family: 'ã„…æ³¨éŸ³èŠ«è½ Regular', "Zen Maru Gothic", sans-serif !important;
        }

        /* CSS Variables for Theming */
        :root {
            /* é è¨­: æº«é¦¨æ‰‹ç¹ª (Light) */
            --bg-paper: #fdfbf7;
            --text-ink: #292524;
            --border-pencil: #57534e;
            --color-highlight: #f59e0b;
            --color-danger: #ef4444;
            --color-success: #10b981;
            --bg-card: #ffffff;
            --bg-modal: #fdfbf7;
            --font-display: "Zen Maru Gothic", sans-serif;
        }

        [data-theme='dark'] {
            /* é»‘æ¿ç²‰ç­† (Dark) */
            --bg-paper: #262626;
            --text-ink: #e5e5e5;
            --border-pencil: #a1a1aa;
            --color-highlight: #facc15;
            --color-danger: #f87171;
            --color-success: #34d399;
            --bg-card: #404040;
            --bg-modal: #262626;
            --font-display: "Zen Maru Gothic", sans-serif;
        }

        [data-theme='tech'] {
            /* ç¾ä»£ç§‘æŠ€ (Tech) - Cyberpunk */
            --bg-paper: #0f172a; /* Slate 900 */
            --text-ink: #38bdf8; /* Sky 400 */
            --border-pencil: #0ea5e9; /* Sky 500 */
            --color-highlight: #f472b6; /* Pink 400 */
            --color-danger: #ef4444;
            --color-success: #22d3ee; /* Cyan 400 */
            --bg-card: #1e293b; /* Slate 800 */
            --bg-modal: #0f172a;
            --font-display: "Orbitron", sans-serif; /* Tech Font */
        }

        [data-theme='cute'] {
            /* æ´»æ½‘å¯æ„› (Cute) - Pop/Pastel */
            --bg-paper: #fff5f7; /* Lavender Blush */
            --text-ink: #881337; /* Rose 900 */
            --border-pencil: #fb7185; /* Rose 400 */
            --color-highlight: #3b82f6; /* Blue 500 */
            --color-danger: #e11d48; /* Rose 600 */
            --color-success: #10b981;
            --bg-card: #ffffff;
            --bg-modal: #fff5f7;
            --font-display: "Zen Maru Gothic", sans-serif;
        }

        body { 
            background-color: var(--bg-paper); 
            color: var(--text-ink); 
            overflow: hidden; 
            transition: background-color 0.5s, color 0.5s;
        }

        /* é€šç”¨æ‰‹ç¹ªé‚Šæ¡†æ¨£å¼ */
        .hand-drawn-border {
            border: 3px solid var(--border-pencil);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.1);
            transition: border-color 0.5s;
        }

        [data-theme='tech'] .hand-drawn-border {
            border-radius: 4px;
            border-width: 2px;
            box-shadow: 0 0 10px var(--border-pencil), inset 0 0 5px var(--border-pencil);
        }
        
        [data-theme='tech'] .font-hand {
            font-family: 'Orbitron', sans-serif !important;
            letter-spacing: 2px;
        }

        [data-theme='cute'] .hand-drawn-border {
            border-radius: 30px;
            border-width: 4px;
            box-shadow: 4px 4px 0px var(--border-pencil);
        }

        .chalk-text {
            text-shadow: 1px 1px 2px rgba(255,255,255,0.1);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-pencil); border-radius: 4px; opacity: 0.5; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- å…¨åŸŸè¨­å®š ---
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbyqOR5f78XoGn2NskpaKOwrXpJJ6P6pvZfgbWI8VFqIb1C7q1gAX3FMMU0VtcNMGDps/exec"; 

        // --- å®Œæ•´å¾Œç«¯ç¨‹å¼ç¢¼ (ç”¨æ–¼é¡¯ç¤ºèˆ‡è¤‡è£½) ---
        const FULL_GAS_CODE = `/**
 * è€ƒå ´ç®¡ç†ç³»çµ± - Google Apps Script Backend API
 * Made by é˜¿å‰›è€å¸«
 * ç‰ˆæœ¬: v1.0
 */

// å®šç¾©è©¦ç®—è¡¨åç¨±èˆ‡æ¬„ä½çµæ§‹ (ç¹é«”ä¸­æ–‡)
const DB_SCHEMA = {
  SCHEDULE: {
    name: "è€ƒç¨‹è¨­å®š",
    headers: ["æ—¥æœŸ", "ç¯€æ¬¡", "ç§‘ç›®", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å‚™è¨»"],
    defaultData: [
      ["2024-01-01", "ç¬¬ä¸€ç¯€", "åœ‹èªæ–‡", "08:20", "09:40", ""],
      ["2024-01-01", "ç¬¬äºŒç¯€", "è‹±èªæ–‡", "10:20", "11:30", "å«è‹±è½"],
      ["2024-01-01", "ç¬¬ä¸‰ç¯€", "æ•¸å­¸",   "13:20", "14:50", ""]
    ]
  },
  MESSAGES: {
    name: "è€ƒå ´èªéŒ„",
    headers: ["é¡¯ç¤ºå…§å®¹", "å•Ÿç”¨ç‹€æ…‹"],
    defaultData: [
      ["ä¿æŒå†·éœï¼Œç´°å¿ƒæª¢æŸ¥", "TRUE"],
      ["æ‰‹æ©Ÿè«‹é—œæ©Ÿä¸¦æ”¾å…¥æ›¸åŒ…", "TRUE"],
      ["è€ƒè©¦çµæŸé˜éŸ¿å‰ï¼Œä¸å¾—ææ—©äº¤å·", "TRUE"],
      ["æ·±å‘¼å¸ï¼Œä½ èƒ½åšåˆ°çš„ï¼", "TRUE"]
    ]
  }
};

function doGet(e) {
  const params = e.parameter;
  const action = params.action || 'getData';
  let result = {};
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    checkAndInitSheets(ss);
    if (action === 'getData') {
      result = {
        status: 'success',
        serverTime: new Date().getTime(),
        schedule: getSheetData(ss, DB_SCHEMA.SCHEDULE.name),
        messages: getSheetData(ss, DB_SCHEMA.MESSAGES.name)
      };
    } else {
      throw new Error("æœªçŸ¥çš„æ“ä½œæŒ‡ä»¤");
    }
  } catch (error) {
    result = { status: 'error', message: error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  let result = {};
  try {
    const postData = JSON.parse(e.postData.contents);
    const action = postData.action;
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    checkAndInitSheets(ss);
    if (action === 'updateSchedule') {
      updateSheetData(ss, DB_SCHEMA.SCHEDULE.name, postData.data);
      result = { status: 'success', message: 'è€ƒç¨‹è¡¨å·²æ›´æ–°' };
    } else if (action === 'updateMessages') {
      updateSheetData(ss, DB_SCHEMA.MESSAGES.name, postData.data);
      result = { status: 'success', message: 'è€ƒå ´èªéŒ„å·²æ›´æ–°' };
    } else {
      throw new Error("æœªçŸ¥çš„æ“ä½œæŒ‡ä»¤");
    }
  } catch (error) {
    result = { status: 'error', message: error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function checkAndInitSheets(ss) {
  Object.values(DB_SCHEMA).forEach(schema => {
    let sheet = ss.getSheetByName(schema.name);
    if (!sheet) {
      sheet = ss.insertSheet(schema.name);
      sheet.appendRow(schema.headers);
      if (schema.defaultData && schema.defaultData.length > 0) {
        schema.defaultData.forEach(row => sheet.appendRow(row));
      }
      sheet.getRange(1, 1, 1, schema.headers.length).setFontWeight("bold").setBackground("#f3f4f6");
      sheet.setFrozenRows(1);
    }
  });
}

function getSheetData(ss, sheetName) {
  const sheet = ss.getSheetByName(sheetName);
  const rows = sheet.getDataRange().getValues();
  if (rows.length < 2) return [];
  const headers = rows[0];
  const data = rows.slice(1);
  return data.map(row => {
    let obj = {};
    headers.forEach((header, index) => {
      let val = row[index];
      if (val instanceof Date) {
        if (header.includes("æ™‚é–“")) {
           let h = val.getHours().toString().padStart(2, '0');
           let m = val.getMinutes().toString().padStart(2, '0');
           val = \`\${h}:\${m}\`;
        } else if (header.includes("æ—¥æœŸ")) {
           let y = val.getFullYear();
           let m = (val.getMonth() + 1).toString().padStart(2, '0');
           let d = val.getDate().toString().padStart(2, '0');
           val = \`\${y}-\${m}-\${d}\`;
        } else {
           val = val.toString();
        }
      }
      obj[header] = val;
    });
    return obj;
  });
}

function updateSheetData(ss, sheetName, newData) {
  const sheet = ss.getSheetByName(sheetName);
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).clearContent();
  }
  if (newData && newData.length > 0) {
    const headers = DB_SCHEMA[Object.keys(DB_SCHEMA).find(key => DB_SCHEMA[key].name === sheetName)].headers;
    const rows = newData.map(item => headers.map(h => item[h] || ""));
    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  }
}`;

        // --- React Icon Component ---
        const Icon = ({ name, className }) => {
            const icons = {
                'x': <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                'loader-2': <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                'timer': <><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></>,
                'edit-2': <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                'trash-2': <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                'plus-circle': <><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>,
                'save': <><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8V3"/></>,
                'palette': <><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></>
            };
            const content = icons[name];
            return content ? (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {content}
                </svg>
            ) : null;
        };

        // --- è¼”åŠ©å‡½å¼ ---
        const generateQRCodeUrl = (data) => `https://quickchart.io/qr?text=${encodeURIComponent(data)}&size=300&margin=2`;
        const formatTime = (date) => (date instanceof Date && !isNaN(date)) ? date.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }) : "00:00";
        const toDateInputValue = (date) => date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');

        const safeCheckIsPast = (currentTime, item) => {
            try {
                if (!item?.['æ—¥æœŸ'] || !item?.['çµæŸæ™‚é–“']) return false;
                const [y, m, d] = String(item['æ—¥æœŸ']).replace(/\//g, '-').split('-').map(Number);
                const [eh, em] = String(item['çµæŸæ™‚é–“']).split(':').map(Number);
                if (isNaN(y) || isNaN(m) || isNaN(d) || isNaN(eh) || isNaN(em)) return false;
                return currentTime > new Date(y, m - 1, d, eh, em, 0);
            } catch (e) {
                console.warn("Date parsing error", e);
                return false;
            }
        };

        const useClock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return time;
        };

        // --- Modal ---
        const Modal = ({ isOpen, title, children, onClose, type = 'info', maxWidth = 'max-w-2xl' }) => {
            if (!isOpen) return null;
            const borderClass = type === 'danger' ? 'border-danger' : 'border-pencil';
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
                    <div className={`bg-modal w-full ${maxWidth} p-6 relative hand-drawn-border ${borderClass} shadow-2xl animate-fade-in flex flex-col max-h-[90vh]`}>
                        <div className="flex justify-between items-center mb-4 border-b-2 border-dashed border-pencil pb-2 flex-shrink-0">
                            <h2 className="text-2xl font-bold font-hand text-ink">{title}</h2>
                            <button onClick={onClose} className="p-2 hover:opacity-50 rounded-full transition"><Icon name="x" /></button>
                        </div>
                        <div className="overflow-y-auto custom-scrollbar flex-1 pr-2 relative text-ink">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- App ---
        const App = () => {
            const currentTime = useClock();
            const [config, setConfig] = useState(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const configParam = urlParams.get('config');
                let initialUrl = DEFAULT_GAS_URL;
                if (configParam) {
                    try { initialUrl = atob(configParam); localStorage.setItem('exam_gas_url', initialUrl); } catch (e) { console.error("Config decode failed", e); }
                } else {
                    const storedUrl = localStorage.getItem('exam_gas_url');
                    if (storedUrl) initialUrl = storedUrl;
                }
                const storedSpeed = localStorage.getItem('marquee_speed');
                return { gasUrl: initialUrl, marqueeSpeed: storedSpeed ? parseInt(storedSpeed, 10) : 25 };
            });

            const [theme, setTheme] = useState(() => localStorage.getItem('exam_theme') || 'light');
            const [useZhuyin, setUseZhuyin] = useState(() => localStorage.getItem('exam_zhuyin') === 'true');
            const [attendance, setAttendance] = useState(() => {
                const saved = localStorage.getItem('exam_attendance');
                return saved ? JSON.parse(saved) : { expected: 0, actual: 0 };
            });
            
            const [schedule, setSchedule] = useState([]);
            const [rawMessages, setRawMessages] = useState([]);
            const [selectedDate, setSelectedDate] = useState(toDateInputValue(new Date()));
            
            const [adminTab, setAdminTab] = useState('schedule');
            const [tempSchedule, setTempSchedule] = useState([]);
            const [tempMessages, setTempMessages] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [modals, setModals] = useState({ settings: false, help: false, admin: false, custom: null });

            useEffect(() => {
                localStorage.setItem('exam_theme', theme);
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark' || theme === 'tech') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [theme]);

            useEffect(() => { localStorage.setItem('exam_zhuyin', useZhuyin); }, [useZhuyin]);
            useEffect(() => { localStorage.setItem('exam_attendance', JSON.stringify(attendance)); }, [attendance]);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('config')) window.history.replaceState({}, document.title, window.location.pathname);
            }, []);

            useEffect(() => {
                if (config.gasUrl) {
                    fetchData();
                } else {
                    setModals(prev => ({ ...prev, settings: true }));
                }
            }, [config.gasUrl]);

            useEffect(() => {
                if (modals.admin) {
                    setTempSchedule(JSON.parse(JSON.stringify(schedule)));
                    setTempMessages(JSON.parse(JSON.stringify(rawMessages)));
                }
            }, [modals.admin, schedule, rawMessages]);

            const fetchData = async () => {
                try {
                    const response = await axios.get(`${config.gasUrl}?action=getData`);
                    const data = response.data;
                    if (data.status === 'success') {
                        setSchedule(data.schedule || []);
                        setRawMessages(data.messages || []);
                    } else {
                        showCustomModal('éŒ¯èª¤', 'è³‡æ–™è®€å–å¤±æ•—: ' + data.message, 'danger');
                    }
                } catch (error) {
                    showCustomModal('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•é€£æ¥å¾Œç«¯ï¼Œè«‹æª¢æŸ¥ URL æ˜¯å¦æ­£ç¢ºæˆ–ç¶²è·¯ç‹€æ…‹ã€‚', 'danger');
                }
            };

            const saveData = async () => {
                if (!config.gasUrl) return;
                setIsSaving(true);
                try {
                    let payload = {};
                    if (adminTab === 'schedule') payload = { action: 'updateSchedule', data: tempSchedule };
                    else if (adminTab === 'messages') payload = { action: 'updateMessages', data: tempMessages };

                    const response = await axios.post(config.gasUrl, JSON.stringify(payload), { headers: { 'Content-Type': 'text/plain' } });

                    if (response.data.status === 'success') {
                        await fetchData();
                        setModals(p => ({...p, admin: false}));
                    } else {
                        throw new Error(response.data.message);
                    }
                } catch (error) {
                    showCustomModal('å„²å­˜å¤±æ•—', error.toString(), 'danger');
                } finally {
                    setIsSaving(false);
                }
            };

            const toggleZhuyin = () => setUseZhuyin(prev => !prev);
            const toggleTheme = () => {
                const themes = ['light', 'dark', 'tech', 'cute'];
                const currentIndex = themes.indexOf(theme);
                setTheme(themes[(currentIndex + 1) % themes.length]);
            };
            const getThemeName = () => ({ 'light': 'æº«é¦¨æ‰‹ç¹ª', 'dark': 'é»‘æ¿ç²‰ç­†', 'tech': 'ç¾ä»£ç§‘æŠ€', 'cute': 'æ´»æ½‘å¯æ„›' }[theme] || 'æœªçŸ¥');

            const handleScheduleChange = (idx, field, val) => {
                const newSchedule = [...tempSchedule];
                newSchedule[idx][field] = val;
                setTempSchedule(newSchedule);
            };
            const addScheduleItem = () => setTempSchedule([...tempSchedule, { 'æ—¥æœŸ': new Date().toISOString().split('T')[0], 'ç¯€æ¬¡': '', 'ç§‘ç›®': '', 'é–‹å§‹æ™‚é–“': '00:00', 'çµæŸæ™‚é–“': '00:00', 'å‚™è¨»': '' }]);
            const removeScheduleItem = (idx) => { if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è€ƒç¨‹å—ï¼Ÿ")) setTempSchedule(tempSchedule.filter((_, i) => i !== idx)); };
            const handleMessageChange = (idx, field, val) => {
                const newMessages = [...tempMessages];
                newMessages[idx][field] = val;
                setTempMessages(newMessages);
            };
            const addMessageItem = () => setTempMessages([...tempMessages, { 'é¡¯ç¤ºå…§å®¹': '', 'å•Ÿç”¨ç‹€æ…‹': 'TRUE' }]);
            const removeMessageItem = (idx) => { if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤èªéŒ„å—ï¼Ÿ")) setTempMessages(tempMessages.filter((_, i) => i !== idx)); };

            const showCustomModal = (title, message, type='info', onConfirm = null) => {
                setModals(prev => ({ ...prev, custom: { title, message, type, onConfirm } }));
            };

            const handleCopy = (text, successTitle = "å·²è¤‡è£½", successMsg = "å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿") => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) showCustomModal(successTitle, successMsg, "success");
                    else throw new Error("Copy command failed");
                } catch (err) {
                    showCustomModal("è¤‡è£½å¤±æ•—", "ç€è¦½å™¨æ¬Šé™å—é™ï¼Œè«‹æ‰‹å‹•é¸å–å…§å®¹ä¸¦è¤‡è£½ã€‚", "danger");
                }
            };

            const currentStatus = useMemo(() => {
                try {
                    if (!schedule.length) return { status: 'idle', subject: 'æš«ç„¡è€ƒè©¦', progress: 0, text: 'æœ¬æ—¥ç„¡å®‰æ’' };
                    const now = currentTime;
                    // ä½¿ç”¨çµ±ä¸€çš„ YYYY-MM-DD æ ¼å¼
                    const todayStr = toDateInputValue(now);
                    
                    // åš´æ ¼æ¯”å°æ—¥æœŸï¼šåªæŠ“å–èˆ‡ã€Œä»Šå¤©ã€å®Œå…¨ç›¸åŒçš„è€ƒç¨‹
                    const todaySchedule = schedule.filter(s => {
                       if (!s || !s['æ—¥æœŸ']) return false;
                       const sDate = String(s['æ—¥æœŸ']).replace(/\//g, '-');
                       return sDate === todayStr;
                    });
                    
                    // è‹¥ä»Šå¤©æ²’æœ‰è€ƒç¨‹ï¼Œç›´æ¥å›å‚³ idleï¼Œä¸ä½¿ç”¨ä»»ä½• fallback
                    if (todaySchedule.length === 0) {
                        return { status: 'idle', subject: 'ä»Šæ—¥ç„¡è€ƒè©¦', progress: 0 };
                    }

                    const targetSchedule = todaySchedule;

                    for (let i = 0; i < targetSchedule.length; i++) {
                        const exam = targetSchedule[i];
                        if (!exam?.['é–‹å§‹æ™‚é–“'] || !exam?.['çµæŸæ™‚é–“']) continue;
                        const [sh, sm] = String(exam['é–‹å§‹æ™‚é–“']).split(':').map(Number);
                        const [eh, em] = String(exam['çµæŸæ™‚é–“']).split(':').map(Number);
                        if ([sh, sm, eh, em].some(isNaN)) continue;

                        const start = new Date(now); start.setHours(sh, sm, 0);
                        const end = new Date(now); end.setHours(eh, em, 0);

                        if (now >= start && now <= end) {
                            const total = (end - start);
                            const elapsed = (now - start);
                            const progress = total > 0 ? Math.min((elapsed / total) * 100, 100) : 0;
                            const endMinutes = end.getHours() * 60 + end.getMinutes();
                            const currentMinutes = now.getHours() * 60 + now.getMinutes();
                            const remaining = Math.max(0, endMinutes - currentMinutes);
                            
                            return { status: 'examining', subject: exam['ç§‘ç›®'], section: exam['ç¯€æ¬¡'], progress, remaining, warning: remaining <= 10, endTime: exam['çµæŸæ™‚é–“'], obj: exam };
                        } else if (now < start) {
                             let prevEnd = new Date(0);
                             if (i > 0) {
                                const prev = targetSchedule[i-1];
                                const [ph, pm] = String(prev['çµæŸæ™‚é–“']).split(':').map(Number);
                                prevEnd = new Date(now); prevEnd.setHours(ph, pm, 0);
                             }
                             if (i === 0 || now > prevEnd) {
                                 const waitMins = Math.floor((start - now) / 60000);
                                 if (waitMins < 60) return { status: 'waiting', subject: exam['ç§‘ç›®'], nextStart: exam['é–‹å§‹æ™‚é–“'], minsToStart: waitMins, obj: exam };
                             }
                        }
                    }
                    return { status: 'idle', subject: 'ç›®å‰ç„¡è€ƒè©¦', progress: 0 };
                } catch (e) {
                    return { status: 'error', subject: 'è³‡æ–™è§£æéŒ¯èª¤', progress: 0 };
                }
            }, [currentTime, schedule]);

            const filteredSchedule = useMemo(() => {
                if (!selectedDate) return [];
                return schedule.filter(s => String(s['æ—¥æœŸ']).replace(/\//g, '-') === selectedDate);
            }, [schedule, selectedDate]);

            const shareUrl = useMemo(() => {
                if (!config.gasUrl) return '';
                const url = new URL(window.location.href);
                url.searchParams.set('config', btoa(config.gasUrl));
                return url.toString();
            }, [config.gasUrl]);

            const marqueeText = useMemo(() => {
                const activeMsgs = rawMessages.filter(m => m['å•Ÿç”¨ç‹€æ…‹'] === true || m['å•Ÿç”¨ç‹€æ…‹'] === 'TRUE').map(m => m['é¡¯ç¤ºå…§å®¹']);
                if (activeMsgs.length === 0) return "æ­¡è¿ä½¿ç”¨è€ƒå ´ç®¡ç†ç³»çµ±ï¼Œè«‹è‡³å¾Œå°è¨­å®šèªéŒ„ã€‚";
                return (activeMsgs.join("ã€€â˜…ã€€") + "ã€€â˜…ã€€").repeat(5);
            }, [rawMessages]);

            const containerClass = `bg-paper text-ink transition-colors duration-500 font-sans ${useZhuyin ? 'font-zhuyin' : ''}`;
            const cardClass = "bg-card border-pencil";
            const inputClass = "w-full p-2 border border-pencil rounded focus:border-highlight outline-none text-sm bg-transparent text-ink";

            return (
                <div className={`w-screen h-screen flex flex-col p-4 ${containerClass}`}>
                    <header className="flex justify-between items-center mb-4 px-4">
                        <div className="flex items-center gap-4">
                            <h1 className="text-3xl font-bold font-hand tracking-widest">ğŸ« è€ƒå ´è³‡è¨Šçœ‹æ¿</h1>
                            <span className="text-xl opacity-70 font-sans">{currentTime.toLocaleDateString('zh-TW', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={toggleZhuyin} className={`flex items-center gap-2 px-4 py-2 rounded-full hover:bg-black/10 transition border-2 ${useZhuyin ? 'border-highlight text-highlight' : 'border-transparent hover:border-pencil'}`} title="åˆ‡æ›æ³¨éŸ³å­—é«”"><span className="font-bold">ã„…ã„†ã„‡</span></button>
                            <button onClick={toggleTheme} className="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-black/10 transition border-2 border-transparent hover:border-pencil" title="åˆ‡æ›ä¸»é¡Œ"><Icon name="palette" className="w-5 h-5" /><span className="font-bold">{getThemeName()}</span></button>
                            <button onClick={() => setModals(p => ({...p, admin: true}))} className="p-3 rounded-full hover:bg-black/10 transition" title="è€ƒç¨‹ç®¡ç†">ğŸ“</button>
                            <button onClick={() => setModals(p => ({...p, settings: true}))} className="p-3 rounded-full hover:bg-black/10 transition" title="è¨­å®š">âš™ï¸</button>
                            <button onClick={() => setModals(p => ({...p, help: true}))} className="p-3 rounded-full hover:bg-black/10 transition" title="èªªæ˜">â„¹ï¸</button>
                        </div>
                    </header>

                    <main className="flex-1 grid grid-cols-12 gap-6 overflow-hidden">
                        <div className="col-span-12 lg:col-span-7 flex flex-col gap-6">
                            <div className={`flex-1 flex flex-col items-center justify-center hand-drawn-border ${cardClass} relative overflow-hidden`}>
                                <div className="text-[12vw] leading-none font-bold tabular-nums tracking-tighter text-center font-tech">{formatTime(currentTime)}</div>
                                <div className="text-4xl mt-4 font-hand opacity-60">ç¾åœ¨æ™‚é–“</div>
                                {currentStatus.status === 'examining' && (<div className="absolute top-4 right-4 bg-danger text-white px-6 py-2 rounded-full font-bold text-2xl animate-pulse shadow-lg">å‰©ä¸‹ {currentStatus.remaining} åˆ†é˜</div>)}
                            </div>
                            <div className={`h-auto min-h-[12rem] p-6 hand-drawn-border ${cardClass} flex flex-col justify-center`}>
                                {currentStatus.status === 'examining' ? (
                                    <>
                                        <div className="flex justify-between items-end mb-4">
                                            <div><span className="text-2xl font-bold bg-highlight text-white px-3 py-1 rounded mr-3 shadow-sm">é€²è¡Œä¸­</span><span className="text-5xl font-bold">{currentStatus.subject}</span></div>
                                            <div className="text-3xl font-bold opacity-50 font-tech">{currentStatus.endTime} çµæŸ</div>
                                        </div>
                                        <div className="w-full relative">
                                            <div className="flex justify-between text-lg font-bold mb-1 px-1">
                                                <span className="opacity-70">æ™‚é–“é€²åº¦</span>
                                                <span className={`tabular-nums ${currentStatus.warning ? 'text-danger animate-pulse' : 'text-highlight'}`}><Icon name="timer" className="inline w-5 h-5 mb-1 mr-1" />å€’æ•¸ {currentStatus.remaining} åˆ†é˜</span>
                                            </div>
                                            <div className="w-full h-12 bg-gray-200 rounded-xl overflow-hidden border-4 border-pencil shadow-inner relative">
                                                <div className={`h-full transition-all duration-1000 ease-linear flex items-center justify-end pr-3 ${currentStatus.warning ? 'bg-danger animate-pulse' : 'bg-highlight'}`} style={{ width: `${currentStatus.progress}%` }}>
                                                    {currentStatus.progress > 5 && (<span className="text-white font-bold text-lg drop-shadow-md">{Math.floor(currentStatus.progress)}%</span>)}
                                                </div>
                                            </div>
                                        </div>
                                        {currentStatus.warning && (<div className="mt-2 text-center text-danger font-bold text-xl animate-bounce">âš ï¸ è«‹æª¢æŸ¥æ¯ä¸€é¡Œæ˜¯å¦éƒ½æœ‰ä½œç­”</div>)}
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-center py-4">
                                        <h2 className="text-4xl font-bold opacity-40 mb-2">{currentStatus.status === 'waiting' ? `ä¸‹ç¯€é å‘Šï¼š${currentStatus.subject}` : 'ç›®å‰ç„¡è€ƒè©¦'}</h2>
                                        {currentStatus.status === 'waiting' && (<p className="text-2xl text-highlight">{currentStatus.nextStart} é–‹å§‹ (é‚„æœ‰ {currentStatus.minsToStart} åˆ†é˜)</p>)}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="col-span-12 lg:col-span-5 flex flex-col gap-6 h-full overflow-hidden">
                            <div className={`flex-1 hand-drawn-border ${cardClass} p-6 overflow-hidden flex flex-col min-h-0`}>
                                <div className="flex justify-between items-center mb-6 border-b-2 border-dashed border-pencil pb-2 flex-shrink-0">
                                    <h2 className="text-3xl font-bold text-center font-hand">ğŸ“… è€ƒç¨‹è¡¨</h2>
                                    <input type="date" className={`p-1 border border-pencil rounded text-lg bg-transparent text-ink focus:border-highlight outline-none`} value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} />
                                </div>
                                <div className="flex-1 overflow-y-auto pr-2 space-y-4 custom-scrollbar">
                                    {filteredSchedule.length === 0 ? (<div className="text-center opacity-50 text-xl mt-10">{schedule.length === 0 ? "è®€å–ä¸­æˆ–ç„¡è€ƒç¨‹è³‡æ–™..." : "æ­¤æ—¥æœŸç„¡è€ƒè©¦å®‰æ’"}</div>) : (
                                        filteredSchedule.map((item, idx) => {
                                            const isCurrent = currentStatus.obj === item;
                                            const isPast = safeCheckIsPast(currentTime, item);
                                            return (
                                                <div key={idx} className={`flex justify-between items-center p-4 rounded-xl border-2 transition-all ${isCurrent ? 'bg-highlight/20 border-highlight scale-105 shadow-lg' : isPast ? 'bg-black/5 border-pencil opacity-60' : 'bg-transparent border-dashed border-pencil'}`}>
                                                    <div className="flex items-center gap-4">
                                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${isCurrent ? 'bg-highlight text-white' : 'bg-gray-200 text-gray-500'}`}>{item['ç¯€æ¬¡'] ? item['ç¯€æ¬¡'].substring(0,2) : ''}</div>
                                                        <div><div className="text-2xl font-bold">{item['ç§‘ç›®']}</div><div className="text-sm opacity-70">{item['å‚™è¨»']}</div></div>
                                                    </div>
                                                    <div className="text-xl font-bold font-tech">{item['é–‹å§‹æ™‚é–“']} - {item['çµæŸæ™‚é–“']}</div>
                                                </div>
                                            )
                                        })
                                    )}
                                </div>
                            </div>

                            <div className={`p-4 hand-drawn-border ${cardClass} flex justify-around items-center shrink-0`}>
                                <div className="text-center group"><div className="text-sm opacity-70 mb-1 font-bold">æ‡‰åˆ°äººæ•¸</div><div className="relative"><input type="number" min="0" className="w-24 text-4xl font-bold text-center bg-transparent border-b-2 border-dashed border-pencil text-ink focus:border-highlight focus:outline-none transition-colors p-1" value={attendance.expected} onChange={(e) => setAttendance({...attendance, expected: Math.max(0, parseInt(e.target.value) || 0)})} /><Icon name="edit-2" className="w-4 h-4 absolute top-0 right-0 opacity-0 group-hover:opacity-30 transition-opacity text-pencil" /></div></div>
                                <div className="text-5xl opacity-20 font-hand">/</div>
                                <div className="text-center group"><div className="text-sm opacity-70 mb-1 font-bold">å¯¦åˆ°äººæ•¸</div><div className="relative"><input type="number" min="0" className="w-24 text-4xl font-bold text-center bg-transparent border-b-2 border-dashed border-pencil text-ink focus:border-highlight focus:outline-none transition-colors p-1" value={attendance.actual} onChange={(e) => setAttendance({...attendance, actual: Math.max(0, parseInt(e.target.value) || 0)})} /><Icon name="edit-2" className="w-4 h-4 absolute top-0 right-0 opacity-0 group-hover:opacity-30 transition-opacity text-pencil" /></div></div>
                                <div className="h-12 w-px bg-pencil opacity-30 mx-4"></div>
                                <div className="text-center"><div className="text-sm opacity-70 mb-1 font-bold">ç¼ºå¸­</div><div className={`text-5xl font-bold ${attendance.expected - attendance.actual > 0 ? 'text-danger animate-pulse-slow' : 'text-success'}`}>{Math.max(0, attendance.expected - attendance.actual)}</div></div>
                            </div>
                        </div>
                    </main>

                    <footer className="mt-6 h-16 bg-gradient-to-r from-stone-800 to-stone-700 rounded-full flex items-center overflow-hidden border-4 border-stone-600 shadow-xl relative text-white">
                        <div className="absolute left-0 bg-stone-800 px-4 z-10 font-bold tracking-widest h-full flex items-center border-r border-stone-600">ğŸ“¢ å…¬å‘Š</div>
                        <div className="whitespace-nowrap animate-marquee text-3xl font-bold ml-4" style={{ animationDuration: `${config.marqueeSpeed}s` }}>{marqueeText}</div>
                        <div className="absolute right-0 bg-stone-800 px-4 z-10 text-xs h-full flex items-center border-l border-stone-600 opacity-50">Made by é˜¿å‰›è€å¸« | CC BY-NC-SA</div>
                    </footer>

                    <Modal isOpen={modals.settings} title="ç³»çµ±é€£ç·šè¨­å®š" onClose={() => setModals(p => ({...p, settings: false}))}>
                        <div className="space-y-6">
                            <p className="text-ink opacity-80">è«‹è¼¸å…¥æ‚¨éƒ¨ç½²çš„ Google Apps Script (Web App) ç¶²å€ä»¥é€£æ¥è³‡æ–™åº«ã€‚</p>
                            <div><label className="block text-sm font-bold mb-2">GAS Web App URL</label><input type="password" className={inputClass} placeholder="https://script.google.com/macros/s/..../exec" value={config.gasUrl} onChange={(e) => setConfig(p => ({...p, gasUrl: e.target.value}))} /></div>
                            <div>
                                <label className="block text-sm font-bold mb-2">å…¬å‘Šæ²å‹•é€Ÿåº¦ (ç§’)</label>
                                <div className="flex items-center gap-4"><input type="range" min="10" max="180" className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" value={config.marqueeSpeed} onChange={(e) => setConfig(p => ({...p, marqueeSpeed: parseInt(e.target.value)}))} /><span className="font-mono font-bold w-12 text-right">{config.marqueeSpeed}s</span></div>
                                <p className="text-xs text-ink opacity-60 mt-1">æ•¸å­—è¶Šå°é€Ÿåº¦è¶Šå¿«ï¼Œé è¨­ç‚º 25 ç§’ã€‚</p>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => { localStorage.setItem('exam_gas_url', config.gasUrl); localStorage.setItem('marquee_speed', config.marqueeSpeed); showCustomModal("å„²å­˜æˆåŠŸ", "è¨­å®šå·²å„²å­˜ï¼Œå°‡é‡æ–°è¼‰å…¥è³‡æ–™ã€‚", "success"); fetchData(); setModals(p => ({...p, settings: false})); }} className="flex-1 bg-highlight text-white py-3 rounded-lg font-bold hover:opacity-90 transition shadow-md">å„²å­˜ä¸¦é€£ç·š</button>
                                <button onClick={() => { localStorage.removeItem('exam_gas_url'); localStorage.removeItem('marquee_speed'); setConfig({ gasUrl: '', marqueeSpeed: 25 }); showCustomModal("å·²æ¸…é™¤", "æ‰€æœ‰æœ¬åœ°è¨­å®šå·²é‡ç½®ã€‚", "warning"); }} className="px-6 border-2 border-pencil rounded-lg font-bold hover:bg-black/5 transition text-ink">é‡ç½®</button>
                            </div>
                            {config.gasUrl && (
                                <div className="bg-black/5 p-4 rounded-lg mt-4">
                                    <h3 className="font-bold mb-2">ğŸ“± æ‰‹æ©Ÿæƒç¢¼/åˆ†äº«é€£çµ</h3>
                                    <div className="flex flex-col md:flex-row gap-4 items-center">
                                        <div className="bg-white p-2 rounded shadow"><img src={generateQRCodeUrl(shareUrl)} alt="QR Code" className="w-32 h-32" /></div>
                                        <div className="flex-1 w-full"><p className="text-xs break-all bg-white p-2 rounded border border-gray-200 mb-2 h-20 overflow-y-auto text-black">{shareUrl}</p><button onClick={() => handleCopy(shareUrl, "å·²è¤‡è£½", "åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿")} className="w-full bg-pencil text-white py-2 rounded hover:opacity-90 text-sm shadow-md">è¤‡è£½é€£çµ (å«è¨­å®šåƒæ•¸)</button></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={modals.admin} title="å¾Œå°ç®¡ç†ä»‹é¢" onClose={() => setModals(p => ({...p, admin: false}))} maxWidth="max-w-4xl">
                        {isSaving && (<div className="absolute inset-0 bg-modal/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm rounded-lg"><Icon name="loader-2" className="w-12 h-12 animate-spin text-highlight mb-2" /><span className="text-lg font-bold text-ink">è³‡æ–™å„²å­˜ä¸­...</span></div>)}
                        <div className="flex flex-col h-full text-ink">
                            <div className="flex gap-2 mb-4 border-b border-pencil pb-2">
                                <button className={`px-4 py-2 rounded-t-lg font-bold ${adminTab === 'schedule' ? 'bg-highlight text-white' : 'bg-black/10 text-ink opacity-60'}`} onClick={() => setAdminTab('schedule')}>è€ƒç¨‹è¨­å®š</button>
                                <button className={`px-4 py-2 rounded-t-lg font-bold ${adminTab === 'messages' ? 'bg-highlight text-white' : 'bg-black/10 text-ink opacity-60'}`} onClick={() => setAdminTab('messages')}>èªéŒ„/å…¬å‘Šè¨­å®š</button>
                            </div>
                            {adminTab === 'schedule' && (
                                <div className="flex-1 flex flex-col gap-4">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-black/10 font-bold text-ink"><tr><th className="p-2 w-32">æ—¥æœŸ</th><th className="p-2 w-20">ç¯€æ¬¡</th><th className="p-2 w-32">ç§‘ç›®</th><th className="p-2 w-24">é–‹å§‹</th><th className="p-2 w-24">çµæŸ</th><th className="p-2">å‚™è¨»</th><th className="p-2 w-12"></th></tr></thead>
                                            <tbody className="divide-y divide-pencil/20">
                                                {tempSchedule.map((item, idx) => (
                                                    <tr key={idx} className="hover:bg-black/5">
                                                        <td className="p-1"><input type="date" className={inputClass} value={item['æ—¥æœŸ']} onChange={e => handleScheduleChange(idx, 'æ—¥æœŸ', e.target.value)} /></td>
                                                        <td className="p-1"><input type="text" className={inputClass} value={item['ç¯€æ¬¡']} onChange={e => handleScheduleChange(idx, 'ç¯€æ¬¡', e.target.value)} /></td>
                                                        <td className="p-1"><input type="text" className={inputClass} value={item['ç§‘ç›®']} onChange={e => handleScheduleChange(idx, 'ç§‘ç›®', e.target.value)} /></td>
                                                        <td className="p-1"><input type="time" className={inputClass} value={item['é–‹å§‹æ™‚é–“']} onChange={e => handleScheduleChange(idx, 'é–‹å§‹æ™‚é–“', e.target.value)} /></td>
                                                        <td className="p-1"><input type="time" className={inputClass} value={item['çµæŸæ™‚é–“']} onChange={e => handleScheduleChange(idx, 'çµæŸæ™‚é–“', e.target.value)} /></td>
                                                        <td className="p-1"><input type="text" className={inputClass} value={item['å‚™è¨»']} onChange={e => handleScheduleChange(idx, 'å‚™è¨»', e.target.value)} /></td>
                                                        <td className="p-1 text-center"><button onClick={() => removeScheduleItem(idx)} className="text-danger hover:bg-danger/10 p-1 rounded"><Icon name="trash-2" className="w-4 h-4" /></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex justify-between items-center mt-2">
                                        <button onClick={addScheduleItem} className="flex items-center gap-2 text-highlight hover:opacity-80 px-3 py-1 rounded border border-highlight"><Icon name="plus-circle" className="w-4 h-4" /> æ–°å¢ä¸€åˆ—</button>
                                        <button onClick={() => saveData('schedule')} disabled={isSaving} className="bg-highlight text-white px-6 py-2 rounded font-bold hover:opacity-90 disabled:opacity-50 flex items-center gap-2 shadow-md">{isSaving ? 'å„²å­˜ä¸­...' : <><Icon name="save" className="w-4 h-4" /> å„²å­˜è®Šæ›´</>}</button>
                                    </div>
                                </div>
                            )}
                            {adminTab === 'messages' && (
                                <div className="flex-1 flex flex-col gap-4">
                                    <div className="space-y-2">
                                        {tempMessages.map((msg, idx) => (
                                            <div key={idx} className="flex items-center gap-2 p-2 border border-pencil rounded hover:bg-black/5 bg-card">
                                                <div className="flex-1"><input type="text" className={inputClass} value={msg['é¡¯ç¤ºå…§å®¹']} onChange={e => handleMessageChange(idx, 'é¡¯ç¤ºå…§å®¹', e.target.value)} placeholder="è«‹è¼¸å…¥é¼“å‹µèªæˆ–è¦å‰‡..." /></div>
                                                <div className="flex items-center gap-2 px-2"><label className="flex items-center cursor-pointer"><input type="checkbox" className="sr-only peer" checked={msg['å•Ÿç”¨ç‹€æ…‹'] === true || msg['å•Ÿç”¨ç‹€æ…‹'] === 'TRUE'} onChange={e => handleMessageChange(idx, 'å•Ÿç”¨ç‹€æ…‹', e.target.checked ? 'TRUE' : 'FALSE')} /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-success relative"></div><span className="ml-2 text-sm text-ink opacity-80 w-12">{msg['å•Ÿç”¨ç‹€æ…‹'] === true || msg['å•Ÿç”¨ç‹€æ…‹'] === 'TRUE' ? 'å•Ÿç”¨' : 'åœç”¨'}</span></label></div>
                                                <button onClick={() => removeMessageItem(idx)} className="text-danger hover:bg-danger/10 p-2 rounded"><Icon name="trash-2" className="w-4 h-4" /></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center mt-2">
                                        <button onClick={addMessageItem} className="flex items-center gap-2 text-highlight hover:opacity-80 px-3 py-1 rounded border border-highlight"><Icon name="plus-circle" className="w-4 h-4" /> æ–°å¢èªéŒ„</button>
                                        <button onClick={() => saveData('messages')} disabled={isSaving} className="bg-highlight text-white px-6 py-2 rounded font-bold hover:opacity-90 disabled:opacity-50 flex items-center gap-2 shadow-md">{isSaving ? 'å„²å­˜ä¸­...' : <><Icon name="save" className="w-4 h-4" /> å„²å­˜è®Šæ›´</>}</button>
                                    </div>
                                </div>
                            )}
                            <div className="mt-4 pt-4 border-t border-pencil text-center text-xs text-ink opacity-50">æç¤ºï¼šè³‡æ–™å„²å­˜å¾Œï¼Œæœƒè‡ªå‹•æ›´æ–°è‡³ Google è©¦ç®—è¡¨ã€‚è‹¥å¤šäººåŒæ™‚ç·¨è¼¯ï¼Œå¾Œå„²å­˜è€…æœƒè¦†è“‹å‰è€…ã€‚</div>
                        </div>
                    </Modal>

                    {modals.custom && (
                        <Modal isOpen={true} title={modals.custom.title} type={modals.custom.type} onClose={() => setModals(p => ({...p, custom: null}))}>
                            <div className="text-center py-4">
                                <p className="text-lg mb-6 text-ink">{modals.custom.message}</p>
                                <button onClick={() => { const callback = modals.custom.onConfirm; setModals(p => ({...p, custom: null})); if (callback) callback(); }} className="bg-pencil text-white px-8 py-2 rounded hover:opacity-90 shadow-md">ç¢ºå®š</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>